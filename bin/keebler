#!/usr/bin/env nu

source keymap.nu

def main [] {
	main process
}

# Map a key string into a QMK keycode.
def "main map" [
	key: string # key alias to map
] {
	let parts = $key | parse "{fn}[{args}]" | get -i 0

	if $key in $keymap {
		$keymap | get $key
	} else if ($parts | is-not-empty) {
    $"(main map $parts.fn)\((main map $parts.args))"
	} else {
		$key
	}
}

# Process all layers and keys into QMK keycodes.
def "main process" [] {
	let data = open data/keebler.nuon

	let layers = $data
	| get layers
	| each {|layer|
		let keycodes = get keys
		| compact
		| each {|key|
			into string
			| main map $in
		}

		$layer | upsert keycodes $keycodes
	}

	$data
	| upsert layers $layers
	| to json
}

def "main build" [] {
	let data = main process

	$data
}
