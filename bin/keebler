#!/usr/bin/env nu

source keymap.nu

def transform [key: string] {
  let parts = $key | parse "{fn}[{args}]" | get -i 0

  if $key in $keymap {
    $keymap | get $key
  } else if ($parts | is-not-empty) {
    $"(transform $parts.fn)\((transform $parts.args))"
  } else {
    $key
  }
}

def generate [] {
}

def main [] {
  let data = open data/keebler.nuon

  let layers = $data
  | get layer_map
  | values
  | each {|layer|
    compact
    | each {|key|
      into string
      | transform $in
    }
  }

  $data
  | upsert layers $layers
  | to json
}

def "main transform" [key: string] {
  transform $key
}
